name: Pull Request Validation

on:
  pull_request:
    branches: [main]
    paths:
      - '**.hcl'
      - '**.tf'
      - 'modules/**'
      - 'environments/**'

env:
  TERRAFORM_VERSION: '1.9.0'
  TERRAGRUNT_VERSION: '0.94.0'

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Validate Modules
        run: |
          for module in modules/*/; do
            echo "Validating $module"
            cd "$module"
            terraform init -backend=false
            terraform validate
            cd - > /dev/null
          done

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          soft_fail: true

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  discover:
    name: Discover Environments
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.find.outputs.environments }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Find Environments
        id: find
        run: |
          ENVS=$(find environments -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "environments=$ENVS" >> $GITHUB_OUTPUT
          echo "Found environments: $ENVS"

  plan:
    name: Plan - ${{ matrix.environment }}
    runs-on: ubuntu-latest
    needs: [validate, security, discover]
    strategy:
      fail-fast: false
      matrix:
        environment: ${{ fromJson(needs.discover.outputs.environments) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Terragrunt Plan - ${{ matrix.environment }}
        id: plan
        run: |
          cd environments/${{ matrix.environment }}
          echo "## Plan for ${{ matrix.environment }}" > plan_output.txt
          echo "" >> plan_output.txt
          terragrunt run-all plan --terragrunt-non-interactive -lock=false 2>&1 | tee -a plan_output.txt

      - name: Upload Plan Output
        uses: actions/upload-artifact@v4
        with:
          name: plan-${{ matrix.environment }}
          path: environments/${{ matrix.environment }}/plan_output.txt

  comment:
    name: Comment PR
    runs-on: ubuntu-latest
    needs: [plan, discover]
    if: always() && needs.discover.result == 'success' && needs.plan.result != 'skipped'
    steps:
      - name: Download All Plan Outputs
        uses: actions/download-artifact@v4
        with:
          path: plans
          pattern: plan-*
          merge-multiple: false

      - name: Combine and Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const plansDir = 'plans';
            if (!fs.existsSync(plansDir) || fs.readdirSync(plansDir).length === 0) {
              console.log('No plan outputs found, skipping comment');
              return;
            }
            
            const planStatus = '${{ needs.plan.result }}';
            const statusEmoji = planStatus === 'success' ? '✅' : '❌';
            
            let body = `## ${statusEmoji} Terragrunt Plan Results\n\n`;
            body += `**Status:** ${planStatus}\n\n`;
            
            const envDirs = fs.readdirSync(plansDir).sort();
            for (const envDir of envDirs) {
              const planFile = path.join(plansDir, envDir, 'plan_output.txt');
              if (fs.existsSync(planFile)) {
                const content = fs.readFileSync(planFile, 'utf8');
                const envName = envDir.replace('plan-', '');
                
                const addMatch = content.match(/(\d+) to add/);
                const changeMatch = content.match(/(\d+) to change/);
                const destroyMatch = content.match(/(\d+) to destroy/);
                
                let summary = '';
                if (addMatch || changeMatch || destroyMatch) {
                  summary = ` (${addMatch?.[0] || '0 to add'}, ${changeMatch?.[0] || '0 to change'}, ${destroyMatch?.[0] || '0 to destroy'})`;
                }
                
                const truncated = content.length > 30000 
                  ? content.substring(0, 30000) + '\n\n... truncated ...' 
                  : content;
                
                body += `<details>\n<summary><b>${envName}</b>${summary}</summary>\n\n\`\`\`hcl\n${truncated}\n\`\`\`\n</details>\n\n`;
              }
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });